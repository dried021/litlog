<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bookfox.repository.ProfileMapper">
    <select id="getProfile" resultType="com.bookfox.model.ProfileDto" parameterType="String">
        SELECT *,
        (SELECT COUNT(*) FROM follow_list WHERE user_id=#{userId}) AS userFollowingCount,
        (SELECT COUNT(*) FROM follow_list WHERE follow_user_id=#{userId}) AS userFollowersCount,
        (SELECT COUNT(*) FROM book_review WHERE user_id=#{userId}) AS userReviewsCount,
        (SELECT COUNT(*) FROM book_collection WHERE user_id=#{userId}) AS userCollectionsCount,
        (SELECT COUNT(*) FROM book_shelf WHERE user_id=#{userId} AND shelf_type=3) AS totalBooksReadCount,
        (SELECT COUNT(*) FROM book_shelf WHERE user_id=#{userId} AND shelf_type=3 
            AND YEAR(creation_date) = YEAR(CURDATE())) AS annualBooksReadCount
        FROM user WHERE id=#{userId}
    </select>
    <select id="getFavoriteBooks" resultType="com.bookfox.model.BookshelfDto" parameterType="map">
        SELECT b.id as bookId, b.title, b.thumbnail,
            CASE
                WHEN ll.id IS NOT NULL THEN 1
                ELSE 0
            END AS like_status
        FROM book b
        JOIN like_list ll ON b.id = ll.target_id
        WHERE ll.user_id = #{userId}
        AND ll.like_type=2
        ORDER BY ll.creation_date DESC
        LIMIT #{count}
    </select>
    <select id="getRecentlyReadBooks" resultType="com.bookfox.model.BookshelfDto" parameterType="map">
        SELECT bs.*,
            CASE 
                WHEN ll.id IS NOT NULL THEN 1
                ELSE 0
            END AS like_status,
            b.thumbnail AS thumbnail,
            br.rating AS rating
        FROM book_shelf bs
        LEFT JOIN like_list ll 
            ON bs.book_id = ll.target_id 
            AND ll.user_id = #{userId} 
            AND ll.like_type = 2
        LEFT JOIN book b
            ON bs.book_id = b.id
        LEFT JOIN book_review br
            ON bs.book_id = br.book_id
            AND br.user_id = #{userId}
        WHERE bs.user_id = #{userId}
            AND bs.shelf_type = 3
        ORDER BY bs.creation_date DESC
        LIMIT #{count}
    </select>
</mapper>